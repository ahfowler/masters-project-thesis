<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <!-- HTML Meta Tags -->
    <title>Virtual Classroom</title>
    <meta name="description" content="Track face and body rigs just your browser webcam!" />

    <!--     Basic Three.js -->
    <script src="https://unpkg.com/three@0.133.0/build/three.js"></script>
    <!-- <script type="module" src="https://unpkg.com/three@0.133.0/examples/jsm/webxr/VRButton.js"></script> -->
    <!--     GLTF Loader for Three.js -->
    <script src="https://unpkg.com/three@0.133.0/examples/js/loaders/GLTFLoader.js"></script>
    <!--     Orbit Controls for Three.js -->
    <script src="https://unpkg.com/three@0.133.0/examples/js/controls/OrbitControls.js"></script>
    <!--     Reflector for Three.js -->
    <script src="https://unpkg.com/three@0.133.0/examples/js/objects/Reflector.js"></script>
    <!--     VRM Loader for Three.js -->
    <script src="https://unpkg.com/@pixiv/three-vrm@0.6.7/lib/three-vrm.js"></script>
    <!--     Mediapipe or Tensorflow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic@0.5.1635989137/holistic.js"
        crossorigin="anonymous"></script>

    <!--     Mediapipe Drawing Tools -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
        crossorigin="anonymous"></script>
    <!--     Mediapipe Camera Tools -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/kalidokit@1.1/dist/kalidokit.umd.js"></script>
</head>

<body>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();
        var onResults, loadUser, removeModel;
        var virtualModels = {};
        var connectedUsers = [];
        var classroomSocketID, mainUserSocketID;

        let cameraXPosition, cameraZPosition, xPosition;

        socket.on('recievedConnectedUsers', function (cUsers, cSocketID) {
            connectedUsers = cUsers;
            classroomSocketID = cSocketID;

            // Initialize the room!
            connectedUsers.forEach((user) => {
                loadUser(user.socketID, user.vrmURL);
            });
        });

        socket.emit("classroomConnected"); // Let everyone know that classroom is online.

        socket.on('recievedMainVRMModel', (vrmURL, mSocketID, userName) => {
            mainUserSocketID = mSocketID;
            console.log("Main User: " + mainUserSocketID, "Classroom: " + classroomSocketID);
            connectedUsers.push({ socketID: mSocketID, userName: userName, vrmURL: vrmURL });
            loadUser(mSocketID, vrmURL);

            socket.on('sentMPResults', function (results, indexSocketID) {
                // console.log(results);

                socket.on('sentRiggedData', function (riggedData, indexSocketID) {
                    // console.log(riggedData);
                    if (virtualModels[indexSocketID]) {
                        virtualModels[indexSocketID].riggedCharacter = riggedData;
                        onResults(results, indexSocketID);
                    }
                });
            });
        });

        // Recieve a new user connection while connected.
        socket.on('recievedVRMModel', (vrmURL, indexSocketID, userName) => {
            connectedUsers.push({ socketID: indexSocketID, userName: userName, vrmURL: vrmURL });
            loadUser(indexSocketID, vrmURL);
        });

        socket.on('removeModel', (indexSocketID) => {
            // Remove from connected users
            // Remove from virtual models

            // Remove from scene.
            removeModel(indexSocketID);
        });

    </script>
    <script type="module" src="./kalidokit.js"></script>
</body>

</html>